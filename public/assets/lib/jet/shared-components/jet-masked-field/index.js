import JetField from"../../shared-components/jet-field/index.js";const patternFindReplaceTokenPositions=(e,t)=>{const n=[];for(let a=0;a<e.length;a++)e[a]===t&&n.push(a);return n},patternBackspace=({value:e,pattern:t,replaceToken:n,replaceTokensPositions:a,selectionStart:l,selectionEnd:r})=>{let i="";if(l!==r){for(let n=0;n<t.length;n++)i+=n>=l&&n<=r?t[n]:e[n];return{value:i,selectionStart:i.indexOf(n)}}const s=a.findLast(e=>l>e),o=a.findLast(e=>r>e);if(!s||!o)return{value:e,selectionStart:l};for(let n=0;n<t.length;n++)i+=n>=s&&n<=o?t[n]:e[n];return{value:i,selectionStart:s}},patternInput=({value:e,typedData:t,selectionStart:n,replaceToken:a,pattern:l})=>{const r=e.indexOf(a);if(-1===r)return{value:e,selectionStart:n};let i="";for(let n=0;n<e.length;n++)n<r?i+=e[n]:t[n-r]?i+=t[n-r]:i+=l[n];return{value:e.replace(a,t),selectionStart:r+1}},patternPaste=({pastedText:e,pattern:t,replaceToken:n})=>{const a=e.replace(/\D/g,"");let l=t;for(let e=0;e<a.length;e++)l=l.replace(n,a[e]);const r=l.indexOf(n);return{value:l,selectionStart:r}};class JetMaskedField extends JetField{constructor(){super()}connectedCallback(){super.connectedCallback();const e=this.getAttribute("pattern"),t=this.getAttribute("replace-token");if(!e)throw new Error("Pattern is required");if(!t)throw new Error("Replace token is Required");if(!e.includes(t))throw new Error("Pattern has no replace token");const n=patternFindReplaceTokenPositions(e,t);this.inputEl.value=e;let a=this.inputEl.value;this.addEventListener("blur",e=>{a!==this.inputEl.value&&this.inputEl.dispatchEvent(new Event("change")),a=this.inputEl.value}),this.inputEl.addEventListener("beforeinput",n=>{const{value:a}=n.target;if(n.preventDefault(),isNaN(parseInt(n.data)))return;const l=patternInput({value:a,typedData:n.data,selectionStart:this.inputEl.selectionStart,replaceToken:t,pattern:e});n.target.value=l.value,this.inputEl.setSelectionRange(l.selectionStart,l.selectionStart)}),this.inputEl.addEventListener("keydown",a=>{if("Backspace"===a.key){a.preventDefault();const{value:l,selectionEnd:r,selectionStart:i}=this.inputEl,s=patternBackspace({value:l,pattern:e,replaceToken:t,replaceTokensPositions:n,selectionStart:i,selectionEnd:r});this.inputEl.value=s.value,this.inputEl.setSelectionRange(s.selectionStart,s.selectionStart)}}),this.inputEl.addEventListener("paste",n=>{const a=n.clipboardData.getData("text/plain");a&&setTimeout(()=>{const{value:n,selectionStart:l}=patternPaste({pastedText:a,pattern:e,replaceToken:t});this.inputEl.value=n,this.inputEl.setSelectionRange(l,l)})})}}export default JetMaskedField;